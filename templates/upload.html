{% extends "base.html" %}

{% block title %}Upload Photos - PropertyScope{% endblock %}

{% block extra_head %}
<style>
    .upload-zone {
        border: 3px dashed #007bff;
        border-radius: 10px;
        padding: 3rem;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: #0056b3;
        background: #e7f1ff;
        transform: translateY(-2px);
    }
    .upload-zone.dragover {
        border-style: solid;
    }
    .file-preview {
        max-height: 300px;
        overflow-y: auto;
    }
    .file-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 0.5rem;
        background: white;
    }
    .file-item img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 1rem;
    }
    .progress-container {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    <i class="fas fa-cloud-upload-alt me-3"></i>Upload Property Photos
                </h1>
                <p class="lead">Upload high-quality drone photos for AI-powered property analysis</p>
            </div>

            <!-- Upload Form -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <form id="uploadForm" method="POST" enctype="multipart/form-data">
                        <!-- Property Address -->
                        <div class="mb-4">
                            <label for="property_address" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-2"></i>Property Address
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="property_address" 
                                   name="property_address" 
                                   placeholder="Enter property address (optional)"
                                   required>
                        </div>

                        <!-- File Upload Zone -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-images me-2"></i>Drone Photos
                            </label>
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                    <h4>Drag & Drop Photos Here</h4>
                                    <p class="text-muted mb-3">or click to browse files</p>
                                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open me-2"></i>Choose Files
                                    </button>
                                    <input type="file" 
                                           id="fileInput" 
                                           name="files[]" 
                                           multiple 
                                           accept="image/*" 
                                           style="display: none;">
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Supported formats: JPG, PNG, GIF. Max 16MB per file.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="file-preview mb-4" style="display: none;">
                            <label class="form-label fw-bold">
                                <i class="fas fa-eye me-2"></i>Selected Photos
                            </label>
                            <div id="fileList"></div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress-container mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-cog fa-spin me-2"></i>Processing...
                            </label>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%"></div>
                            </div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">Analyzing property conditions and estimating costs...</small>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="fas fa-brain me-2"></i>Analyze Property
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="row mt-5">
                <div class="col">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-lightbulb text-warning me-2"></i>Tips for Best Results
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="tip-card p-3 bg-light rounded">
                                <h6><i class="fas fa-camera me-2"></i>Photo Quality</h6>
                                <p class="mb-0 small">Use high-resolution images (minimum 1080p) for accurate analysis.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tip-card p-3 bg-light rounded">
                                <h6><i class="fas fa-expand me-2"></i>Multiple Angles</h6>
                                <p class="mb-0 small">Include photos from different angles and heights of the property.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tip-card p-3 bg-light rounded">
                                <h6><i class="fas fa-sun me-2"></i>Good Lighting</h6>
                                <p class="mb-0 small">Capture photos in good daylight conditions for better visibility.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tip-card p-3 bg-light rounded">
                                <h6><i class="fas fa-home me-2"></i>Full Coverage</h6>
                                <p class="mb-0 small">Include roof, exterior, landscaping, and hardscaping in your shots.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    const submitBtn = document.getElementById('submitBtn');
    const uploadForm = document.getElementById('uploadForm');
    const progressContainer = document.querySelector('.progress-container');
    const progressBar = document.querySelector('.progress-bar');
    
    let selectedFiles = [];

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    uploadZone.addEventListener('click', function() {
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        selectedFiles = Array.from(files);
        displayFiles();
        updateSubmitButton();
    }

    function displayFiles() {
        if (selectedFiles.length === 0) {
            filePreview.style.display = 'none';
            return;
        }

        filePreview.style.display = 'block';
        fileList.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                fileItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${file.name}</div>
                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            };
            reader.readAsDataURL(file);
            
            fileList.appendChild(fileItem);
        });
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        displayFiles();
        updateSubmitButton();
        
        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    };

    function updateSubmitButton() {
        submitBtn.disabled = selectedFiles.length === 0;
    }

    // Form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        if (selectedFiles.length === 0) {
            e.preventDefault();
            alert('Please select at least one photo to upload.');
            return;
        }

        // Show progress
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;
        
        // Animate progress bar
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 500);

        // Stop animation when form actually submits
        setTimeout(() => {
            clearInterval(interval);
            progressBar.style.width = '100%';
        }, 3000);
    });
});
</script>
{% endblock %}